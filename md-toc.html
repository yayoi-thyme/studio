<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script>
$(function() {
  const search = $(location).attr('search').slice(1)
  const character_to_replace = [
    [" ", ""],
    [".", ""],
    [",", ""],
    ["'", ""],
    ["\"", ""],
    ["\/", ""],
    ["\\", ""],
    ["(", ""],
    [")", ""],
    ["[", ""],
    ["]", ""],
    ["{", ""],
    ["}", ""],
    ["<", ""],
    [">", ""],
    ["。", ""],
    ["、", ""],
    ["・", ""],
    ["（", ""],
    ["）", ""],
    ["「", ""],
    ["」", ""],
    ["｛", ""],
    ["｝", ""]
  ]
  const indent_character = "\t"
  var list_array = {}
  var list_array_length = 0
  $.ajax({
    url: search,
    dataType: 'text',
    cache: 'false',
  })
  .then(function(data) {
    /*
      見出し以外の行を削除し、残った見出し行をリスト化 heading する
    */
    var dfr = $.Deferred()
    const list_array_pre = data.replace(/^[^#\n].*?$/gm, '').replace(/(\n(?=\n)|\n$)/g, '').split('\n')
    list_array_length = list_array_pre.length
    for (var i = 0; i <= list_array_length - 1; i++) {
      list_array[i] = {'id': i, 'heading': list_array_pre[i].replace(/^#*?\s(.*)/, '$1'), 'indent': list_array_pre[i].replace(/(.*)/, indent_character.repeat(list_array_pre[i].replace(/^(#*?)\s.*$/, '$1').length - 1))}
      if (i === list_array_length - 1) {
        dfr.resolve()
      }
    }
    return dfr.promise()
  })
  .then(function() {
    var dfr = $.Deferred()
    // 見出し文字列からリンク文字列 link を作成し、 GitHub によって置換される文字の処理を行う
    const character_to_replace_length = character_to_replace.length
    for (var i = 0; i <= list_array_length - 1; i++) {
      for (var j = 0; j <= character_to_replace_length; j++) {
        const work1 = list_array[i]['heading']
        list_array[i]['link'] = work1.replace(character_to_replace[0][j], character_to_replace[1][i]).replace(/^#*\s(.*?)/, '$1')
        if (i === list_array_length - 1 && j === character_to_replace_length) {
          dfr.resolve()
        }
      }
    }
    return dfr.promise()
  })
  .then(function() {
    // TOC 生成
    var dfr = $.Deferred()
    var toc_data = ''
    for (var i = 0; i <= list_array_length - 1; i++) {
      toc_data = toc_data + list_array[i]['indent'] + '* [' + list_array[i]['heading'] + '](#' + list_array[i]['link'] + ')\n'
      if (i === list_array_length - 1) {
        dfr.resolve(toc_data)
      }
    }
    return dfr.promise()
  })
  .then(function(toc_data) {
    // 書き出し
    $('#toc').text(toc_data)
  })
  function generateArrayFilled(length, items, fill) {
    var array = new Array(length)
    for (var i = length - 1; i >= 0; i--) {
      array[i] = new Array(items)
      for (var j = items - 1; j >= 0; j--) {
        array[i][j] = fill
      }
    }
    return array
  }
})
</script>
<style>

</style>
<body>
<pre id="toc"></pre>
</body>